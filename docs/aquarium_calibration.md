# 鱼缸边界标定指南

## 功能说明

系统支持在摄像头画面中绘制鱼缸边界，并将检测到的鱼的位置转换为相对于鱼缸边界的归一化坐标（0-1范围）。这有助于：

1. **视觉参考**：在调试画面中清晰看到鱼缸边界
2. **坐标归一化**：将鱼的像素坐标转换为相对于鱼缸的相对坐标
3. **精确控制**：基于鱼缸边界进行更精确的运动控制

## 标定步骤

### 1. 运行标定工具

```bash
cd ~/fishcar
source ~/fishcar-venv/bin/activate
python -m raspi.src.calibrate_aquarium
```

或者使用完整路径：

```bash
python ~/fishcar/src/calibrate_aquarium.py
```

### 2. 交互式标定

1. 标定工具会打开摄像头画面
2. **按顺序点击四个角点**：
   - 第一个点：左上角（Top-Left）
   - 第二个点：右上角（Top-Right）
   - 第三个点：右下角（Bottom-Right）
   - 第四个点：左下角（Bottom-Left）

3. 点击完四个点后，会显示边界框
4. 按 **SPACE** 确认保存，或按 **ESC** 取消

### 3. 标定数据保存

标定数据会自动保存到配置文件指定的路径（默认：`~/fishcar/raspi/config/calibration.json`）

## 使用效果

标定完成后，运行主程序时会：

1. **显示鱼缸边界**：黄色线条绘制鱼缸四个角点
2. **显示相对坐标**：
   - 在检测框上方显示：`Rel: (x, y)`，其中 x, y 是 0-1 范围的归一化坐标
   - 在画面左上角显示：`Rel Coords: (x, y)`

### 坐标说明

- **相对坐标范围**：0.0 到 1.0
  - `(0.0, 0.0)` = 鱼缸左上角
  - `(1.0, 1.0)` = 鱼缸右下角
  - `(0.5, 0.5)` = 鱼缸中心

- **坐标计算**：基于鱼缸边界矩形，将像素坐标转换为相对坐标

## 配置文件

在 `raspi/config/default.yaml` 中可以配置：

```yaml
visualization:
  show_aquarium_bounds: true   # 是否显示鱼缸边界
  show_relative_coords: true   # 是否显示相对坐标

calibration_path: "/home/pi/fishcar/raspi/config/calibration.json"  # 标定文件路径
```

## 重新标定

如果需要重新标定（例如摄像头位置改变），只需再次运行标定工具即可，新的标定数据会覆盖旧的。

## 注意事项

1. **标定精度**：尽量准确点击四个角点，建议在鱼缸边缘清晰可见时进行标定
2. **摄像头稳定**：标定前确保摄像头位置固定，标定后不要移动摄像头
3. **光照条件**：在正常光照条件下标定，避免反光或阴影影响边界识别
4. **边界检测**：如果鱼游到鱼缸边界外，相对坐标会显示为 `None`（不在边界内）

## 故障排除

### 标定工具无法启动

- 检查摄像头是否正常：`v4l2-ctl --list-devices`
- 检查配置文件路径是否正确
- 确保虚拟环境已激活

### 标定数据未加载

- 检查标定文件是否存在：`ls ~/fishcar/raspi/config/calibration.json`
- 检查文件格式是否正确（JSON格式）
- 查看日志输出是否有错误信息

### 边界显示不正确

- 重新运行标定工具
- 确保点击的四个点顺序正确
- 检查摄像头是否移动过位置



