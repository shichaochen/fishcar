# Arduino 与树莓派硬件连接指南

## 连接概览

```
树莓派 <--USB串口--> Arduino <--I2C--> 电机驱动板
                      |
                      +--数字引脚--> 微动开关
```

## 1. 树莓派与 Arduino 连接

### 方法一：USB 连接（推荐）

**连接方式**：
- 使用 USB 数据线将 Arduino 连接到树莓派的 USB 端口
- Arduino UNO/Nano 通常使用 USB-B 或 Micro-USB 接口

**优点**：
- 简单可靠，即插即用
- 自动识别设备（`/dev/ttyACM0` 或 `/dev/ttyUSB0`）
- 无需额外配置

**配置**：
- 在 `raspi/config/default.yaml` 中设置：
  ```yaml
  serial:
    port: "/dev/ttyACM0"  # 或 /dev/ttyUSB0
    baudrate: 9600
  ```

**检查连接**：
```bash
# 查看串口设备
ls -l /dev/ttyACM* /dev/ttyUSB*

# 测试串口通信
python ~/fishcar/arduino/scripts/send_test.py /dev/ttyACM0
```

### 方法二：GPIO 串口连接（可选）

如果使用 GPIO 串口，需要连接：

| 树莓派 GPIO | Arduino | 说明 |
|------------|---------|------|
| GPIO 14 (TXD) | D0 (RX) | 树莓派发送，Arduino 接收 |
| GPIO 15 (RXD) | D1 (TX) | 树莓派接收，Arduino 发送 |
| GND | GND | 共地（必须） |

**注意事项**：
- 树莓派的 GPIO 串口是 3.3V 电平，Arduino UNO 是 5V 电平
- 建议使用电平转换模块（如 TXB0104）或使用 3.3V 的 Arduino（如 Arduino Pro Mini 3.3V）
- 需要禁用树莓派的串口控制台功能

**禁用串口控制台**（如果使用 GPIO 串口）：
```bash
sudo raspi-config
# 选择 Interface Options -> Serial Port
# 禁用 Serial Login，启用 Serial Interface
```

## 2. Arduino 与电机驱动板连接（I2C）

根据代码，Arduino 通过 I2C 与电机驱动板通信：

| Arduino | 电机驱动板 | 说明 |
|---------|-----------|------|
| A4 (SDA) | SDA | I2C 数据线 |
| A5 (SCL) | SCL | I2C 时钟线 |
| 5V | VCC | 电源（如果驱动板需要） |
| GND | GND | 共地（必须） |

**I2C 地址**：`0x34`（在代码中定义）

**注意事项**：
- I2C 总线需要上拉电阻（通常驱动板已内置）
- 确保 I2C 地址正确（可通过 I2C 扫描工具检查）
- 线长建议不超过 30cm

## 3. 微动开关连接

根据代码，四个微动开关连接到 Arduino 数字引脚：

| 微动开关 | Arduino 引脚 | 说明 |
|---------|-------------|------|
| 前（Front） | D2 | 检测前方碰撞 |
| 后（Back） | D3 | 检测后方碰撞 |
| 左（Left） | D4 | 检测左侧碰撞 |
| 右（Right） | D5 | 检测右侧碰撞 |

**连接方式**：
- 微动开关一端连接到对应 Arduino 引脚
- 另一端连接到 GND
- Arduino 使用 `INPUT_PULLUP` 模式（内部上拉）
- 开关闭合时引脚为 LOW，断开时为 HIGH

**接线示意图**：
```
微动开关 ----[引脚] Arduino D2/D3/D4/D5
    |
    +----[GND] Arduino GND
```

**测试**：
```bash
# 在 Arduino 串口监视器中，手动按下开关
# 应该看到：STATUS front=1 back=0 left=0 right=0
```

## 4. 电源连接

### Arduino 电源
- **USB 供电**：通过 USB 连接树莓派时，Arduino 由 USB 供电（5V，约 500mA）
- **外部供电**：如果电流需求大，可使用外部电源适配器（7-12V DC）

### 电机驱动板电源
- **电机电源**：12V 电池组连接到驱动板的电机电源接口
- **逻辑电源**：通常由 Arduino 的 5V 提供，或使用独立的 5V 电源

**重要**：
- 所有模块的 GND 必须共地连接
- 电机电源和逻辑电源的地线必须连接在一起

## 5. 完整连接示意图

```
┌─────────────┐
│  树莓派 5   │
│             │
│  USB 端口   │───USB线───┐
└─────────────┘           │
                          │
                    ┌─────▼─────┐
                    │  Arduino   │
                    │  UNO/Nano  │
                    │            │
                    │ D2-D5 ────┼─── 微动开关（4个）
                    │            │
                    │ A4 (SDA) ──┼─── I2C SDA
                    │ A5 (SCL) ──┼─── I2C SCL
                    │ GND ───────┼─── 共地
                    └─────┬──────┘
                          │
                    ┌─────▼─────┐
                    │ 电机驱动板 │
                    │  (I2C)    │
                    │            │
                    │ 12V 电池 ──┼─── 电机电源
                    │            │
                    │ 电机输出 ──┼─── 4个麦克纳姆轮电机
                    └────────────┘
```

## 6. 连接检查清单

### 串口连接检查
- [ ] Arduino 通过 USB 连接到树莓派
- [ ] 树莓派能识别设备：`ls /dev/ttyACM*`
- [ ] 串口权限已配置：用户已加入 `dialout` 组
- [ ] 配置文件中的串口路径正确

### I2C 连接检查
- [ ] I2C 线（SDA/SCL）正确连接
- [ ] 共地连接正确
- [ ] 电机驱动板 I2C 地址为 `0x34`
- [ ] 可以使用 I2C 扫描工具检测到设备

### 微动开关检查
- [ ] 四个开关分别连接到 D2, D3, D4, D5
- [ ] 开关另一端连接到 GND
- [ ] 按下开关时，串口输出状态变化

### 电源检查
- [ ] Arduino 有电源（USB 或外部电源）
- [ ] 电机驱动板有 12V 电源
- [ ] 所有模块共地连接
- [ ] 电源电压稳定，电流充足

## 7. 故障排除

### 串口无法连接

**问题**：树莓派无法识别 Arduino

**解决**：
```bash
# 检查 USB 设备
lsusb

# 检查串口设备
ls -l /dev/ttyACM* /dev/ttyUSB*

# 检查权限
groups  # 确认用户在 dialout 组

# 如果设备不存在，尝试重新插拔 USB 线
```

### I2C 通信失败

**问题**：Arduino 无法与电机驱动板通信

**解决**：
```bash
# 在树莓派上扫描 I2C 设备（如果 Arduino 也连接到树莓派 I2C）
sudo apt install i2c-tools
i2c-detect -y 1  # 查看 I2C 设备列表

# 检查 I2C 线连接
# 确认 SDA/SCL 没有接反
# 确认共地连接
```

### 微动开关无响应

**问题**：按下开关无反应

**解决**：
- 检查开关是否连接到正确的引脚
- 检查开关是否连接到 GND
- 使用万用表测试开关是否正常工作
- 检查 Arduino 代码中的引脚定义

### 电机不转

**问题**：发送指令后电机不转

**解决**：
- 检查 I2C 通信是否正常（查看串口输出 `SPEED OK` 或 `SPEED ERR`）
- 检查电机驱动板电源是否正常
- 检查电机线连接是否正确
- 检查电机驱动板配置（电机类型、编码器极性等）

## 8. 安全注意事项

1. **电源安全**：
   - 确保电源电压匹配（Arduino 5V，电机 12V）
   - 使用合适的保险丝保护电路
   - 避免短路

2. **接地**：
   - 所有模块必须共地
   - 避免接地环路

3. **线缆**：
   - 使用合适的线径（电机线需要较粗）
   - 固定线缆，避免拉扯
   - 使用杜邦线或焊接，确保连接可靠

4. **测试**：
   - 先测试通信，再测试电机
   - 逐步增加速度，观察电机反应
   - 准备好紧急停止措施

## 9. 推荐工具

- **万用表**：测试电压、通断
- **示波器**（可选）：检查信号质量
- **I2C 扫描工具**：检测 I2C 设备
- **串口调试工具**：测试串口通信

## 10. 下一步

连接完成后，按照以下顺序测试：

1. **串口通信测试**：使用 `send_test.py` 脚本
2. **微动开关测试**：手动触发开关，查看状态输出
3. **I2C 通信测试**：发送速度指令，查看 `SPEED OK` 反馈
4. **电机测试**：逐步增加速度，观察电机转动
5. **系统联调**：运行完整程序，观察小车跟随小鱼移动



